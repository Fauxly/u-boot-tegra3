name: Build U-Boot

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      defconfig:
        description: "transformer_t30_defconfig"
        required: true
        default: "qemu_arm_defconfig"
      arch:
        description: "ARCH"
        required: true
        default: "arm"
      cross:
        description: "Cross-compiler prefix"
        required: true
        default: "arm-linux-gnueabihf-"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex \
            libssl-dev libelf-dev \
            device-tree-compiler \
            gcc-arm-linux-gnueabihf \
            git make

      - name: Show toolchain
        run: |
          which ${{ inputs.cross }}gcc || true
          ${{ inputs.cross }}gcc --version || true

      - name: Configure
        run: |
          make distclean
          make ARCH=${{ inputs.arch }} CROSS_COMPILE=${{ inputs.cross }} ${{ inputs.defconfig }}

      - name: Build
        run: |
          make -j"$(nproc)" ARCH=${{ inputs.arch }} CROSS_COMPILE=${{ inputs.cross }}

      - name: Collect artifacts
        run: |
          mkdir -p out
          # Часто встречающиеся выходные файлы U-Boot (не все будут существовать для каждой платы)
          cp -v u-boot  out/ 2>/dev/null || true
          cp -v u-boot.bin out/ 2>/dev/null || true
          cp -v u-boot.img out/ 2>/dev/null || true
          cp -v u-boot-dtb.bin out/ 2>/dev/null || true
          cp -v spl/u-boot-spl.bin out/ 2>/dev/null || true
          cp -v MLO out/ 2>/dev/null || true
          cp -v System.map out/ 2>/dev/null || true
          cp -v .config out/ 2>/dev/null || true
          echo "Artifacts:"
          ls -la out

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: u-boot-${{ inputs.arch }}-${{ inputs.defconfig }}
          path: out
          if-no-files-found: warn
